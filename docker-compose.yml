# ============================================================================
# Docker Compose Configuration for Production Deployment
# ============================================================================
# This file combines:
# - Traefik reverse proxy with SSL
# - Next.js/Payload CMS application (3 instances with load balancing)
# - Geocoding services (Nominatim & Photon)
# Note: MongoDB is hosted on MongoDB Atlas (cloud), not in this compose file
#
# IMPORTANT: This configuration uses Docker Swarm mode for scaling and rolling updates.
# To deploy:
#   1. Initialize Swarm: docker swarm init
#   2. Create volumes: docker volume create traefik_data
#   3. Deploy stack: docker stack deploy -c docker-compose.yml adaptmap
#   4. Scale app: docker service scale adaptmap_app=3
#   5. Rolling update: docker service update --image <new-image> adaptmap_app
#
# For regular docker-compose (without Swarm):
#   - Remove the `deploy` sections
#   - Use: docker-compose up -d --scale app=3
#   - Note: Rolling updates won't work without Swarm mode
#
# Environment Variables Required:
#   - DOMAIN_NAME (e.g., "example.com") - REQUIRED in both GitHub Secrets AND server .env
#   - SSL_EMAIL (for Let's Encrypt) - server .env only
#   - DATABASE_URI (MongoDB Atlas connection string) - server .env only
#   - PAYLOAD_SECRET - server .env only
#   - NOMINATIM_PASSWORD - server .env only
#   - SMTP_HOST, SMTP_USERNAME, SMTP_PASSWORD (optional) - server .env only
#   - CRON_SECRET (optional) - server .env only
#   - SESSION_LOG_SECRET (optional) - server .env only
#
# IMPORTANT: NEXT_PUBLIC_* variables MUST be available at build time!
# They're embedded in the client JavaScript bundle during `next build`.
# Build happens on GitHub Actions, so DOMAIN_NAME must be in GitHub Secrets.
#
# Quick Start (Swarm Mode):
#   1. Create .env file with required variables
#   2. Initialize: docker swarm init
#   3. Create volume: docker volume create traefik_data
#   4. Deploy: docker stack deploy -c docker-compose.yml adaptmap
#   5. Monitor: docker service logs -f adaptmap_app
# ============================================================================

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - --api=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.mytlschallenge.acme.tlschallenge=true
      - --certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}
      - --certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json
    restart: always
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - app-network
      - geocoding-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # NEXT_PUBLIC_* vars MUST be build args (embedded in client bundle at build time)
        - NEXT_PUBLIC_SERVER_URL=https://${DOMAIN_NAME}
        - NEXT_PUBLIC_PHOTON_URL=https://photon.${DOMAIN_NAME}
        # Optional: These are runtime-only for Payload CMS, but can be passed here
        # They'll be overridden by environment section below at runtime anyway
        - DATABASE_URI=${DATABASE_URI:-}
        - PAYLOAD_SECRET=${PAYLOAD_SECRET:-}
        - SMTP_HOST=${SMTP_HOST:-}
        - SMTP_USERNAME=${SMTP_USERNAME:-}
        - SMTP_PASSWORD=${SMTP_PASSWORD:-}
        - CRON_SECRET=${CRON_SECRET:-}
        - SESSION_LOG_SECRET=${SESSION_LOG_SECRET:-}
    restart: always
    deploy:
      replicas: 3
      update_config:
        parallelism: 1 # Update one instance at a time
        delay: 10s # Wait 10 seconds between updates
        failure_action: rollback # Rollback on failure
        monitor: 60s # Monitor health for 60 seconds
        order: start-first # Start new instance before stopping old one
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        monitor: 60s
        order: stop-first # Stop old instance before starting new one
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    labels:
      - traefik.enable=true
      - traefik.http.routers.app.rule=Host(`${DOMAIN_NAME}`)
      - traefik.http.routers.app.tls=true
      - traefik.http.routers.app.entrypoints=web,websecure
      - traefik.http.routers.app.tls.certresolver=mytlschallenge
      - traefik.http.middlewares.app.headers.SSLRedirect=true
      - traefik.http.middlewares.app.headers.STSSeconds=315360000
      - traefik.http.middlewares.app.headers.browserXSSFilter=true
      - traefik.http.middlewares.app.headers.contentTypeNosniff=true
      - traefik.http.middlewares.app.headers.forceSTSHeader=true
      - traefik.http.middlewares.app.headers.SSLHost=${DOMAIN_NAME}
      - traefik.http.middlewares.app.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.app.headers.STSPreload=true
      - traefik.http.routers.app.middlewares=app@docker
      - traefik.http.services.app.loadbalancer.server.port=3000
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_PUBLIC_SERVER_URL=https://${DOMAIN_NAME}
      - DATABASE_URI=${DATABASE_URI}
      - PAYLOAD_SECRET=${PAYLOAD_SECRET}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - CRON_SECRET=${CRON_SECRET:-}
      - SESSION_LOG_SECRET=${SESSION_LOG_SECRET:-}
      # Geocoding service URLs (internal Docker network)
      # Note: GEOCODING_URL (Nominatim) is runtime-only - only used server-side in API routes
      # NEXT_PUBLIC_PHOTON_URL is set in build args above (needed at build time for client bundle)
      - GEOCODING_URL=http://nominatim:8080
      - PHOTON_URL=http://photon:2322
      - NEXT_PUBLIC_PHOTON_URL=https://photon.${DOMAIN_NAME} # Also set at runtime (but build-time value is what matters)
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health', '||', 'exit', '1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s # Allow 40 seconds for initial startup
    depends_on:
      nominatim:
        condition: service_healthy
    networks:
      - app-network
      - geocoding-network

  nominatim:
    # Nominatim is the reverse geocoding service (coordinates → address)
    image: mediagis/nominatim:4.2
    container_name: nominatim
    restart: unless-stopped

    # Expose port 8080 - accessible through Traefik or internally
    ports:
      - '127.0.0.1:8080:8080' # Only accessible from localhost (use Traefik for external)
    labels:
      - traefik.enable=true
      - traefik.http.routers.nominatim.rule=Host(`nominatim.${DOMAIN_NAME}`)
      - traefik.http.routers.nominatim.tls=true
      - traefik.http.routers.nominatim.entrypoints=web,websecure
      - traefik.http.routers.nominatim.tls.certresolver=mytlschallenge
      - traefik.http.services.nominatim.loadbalancer.server.port=8080

    # Persistent storage for database and data
    volumes:
      - nominatim-data:/var/lib/postgresql/14/main # Database storage
      - nominatim-flatnode:/nominatim/flatnode # Index storage

    environment:
      # ====================================================================
      # IMPORTANT: Choose your region!
      # ====================================================================
      # Option 1: NRW only (faster, less resources) - RECOMMENDED FOR TESTING
      # - PBF_URL=https://download.geofabrik.de/europe/germany/nordrhein-westfalen-latest.osm.pbf
      # - REPLICATION_URL=https://download.geofabrik.de/europe/germany/nordrhein-westfalen-updates/
      #
      # Option 2: All of Germany (slower, more resources) - FOR PRODUCTION
      - PBF_URL=https://download.geofabrik.de/europe/germany-latest.osm.pbf
      - REPLICATION_URL=https://download.geofabrik.de/europe/germany-updates/
      # ====================================================================

      # Disable features we don't need (saves time and space)
      - IMPORT_WIKIPEDIA=false
      - IMPORT_US_POSTCODES=false

      # Database password - MUST be set in .env file!
      - NOMINATIM_PASSWORD=${NOMINATIM_PASSWORD:-change_me_in_production}

    # Health check - Docker will verify the service is working
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/status']
      interval: 30s # Check every 30 seconds
      timeout: 10s # Wait 10 seconds for response
      retries: 3 # Try 3 times before marking as unhealthy
      start_period: 2h # Allow 2 hours for initial import (this is normal!)

    # Resource limits - adjust based on your VPS capacity
    deploy:
      resources:
        limits:
          memory: 6G # Maximum RAM Nominatim can use
        reservations:
          memory: 4G # Minimum RAM to reserve for Nominatim
    networks:
      - geocoding-network

  photon:
    # Photon is the forward geocoding service (address → coordinates)
    build:
      context: .
      dockerfile: Dockerfile.photon
    container_name: photon
    restart: unless-stopped

    # Expose port 2322 - accessible through Traefik or internally
    ports:
      - '127.0.0.1:2322:2322' # Only accessible from localhost (use Traefik for external)
    labels:
      - traefik.enable=true
      - traefik.http.routers.photon.rule=Host(`photon.${DOMAIN_NAME}`)
      - traefik.http.routers.photon.tls=true
      - traefik.http.routers.photon.entrypoints=web,websecure
      - traefik.http.routers.photon.tls.certresolver=mytlschallenge
      - traefik.http.services.photon.loadbalancer.server.port=2322

    environment:
      # Photon connects to Nominatim's database (they share data)
      - NOMINATIM_HOST=nominatim # Internal Docker network name
      - NOMINATIM_PORT=5432 # PostgreSQL port
      - NOMINATIM_DB=nominatim # Database name
      - NOMINATIM_USER=nominatim # Database user
      - NOMINATIM_PASSWORD=${NOMINATIM_PASSWORD:-change_me_in_production} # Same password as Nominatim
    command: >
      sh -c "java -jar /app/photon.jar
      -nominatim-import:host=nominatim
      -nominatim-import:port=5432
      -nominatim-import:database=nominatim
      -nominatim-import:user=nominatim
      -nominatim-import:password=$${NOMINATIM_PASSWORD}"

    # Wait for Nominatim to be healthy before starting
    depends_on:
      nominatim:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:2322/api?q=test']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - geocoding-network

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    command: ['redis-server', '--appendonly', 'yes']
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN_NAME}`)
      - traefik.http.routers.n8n.tls=true
      - traefik.http.routers.n8n.entrypoints=web,websecure
      - traefik.http.routers.n8n.tls.certresolver=mytlschallenge
      - traefik.http.middlewares.n8n.headers.SSLRedirect=true
      - traefik.http.middlewares.n8n.headers.STSSeconds=315360000
      - traefik.http.middlewares.n8n.headers.browserXSSFilter=true
      - traefik.http.middlewares.n8n.headers.contentTypeNosniff=true
      - traefik.http.middlewares.n8n.headers.forceSTSHeader=true
      - traefik.http.middlewares.n8n.headers.SSLHost=${DOMAIN_NAME}
      - traefik.http.middlewares.n8n.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.n8n.headers.STSPreload=true
      - traefik.http.routers.n8n.middlewares=n8n@docker
    environment:
      - N8N_HOST=n8n.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.${DOMAIN_NAME}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Europe/Berlin}
      - N8N_PROXY_HOPS=1
      # Redis configuration for n8n queue mode
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      # Enable queue mode for better performance and scalability
      - EXECUTIONS_MODE=queue
    restart: always
    ports:
      - '127.0.0.1:5678:5678'
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app-network

# ============================================================================
# Volumes - Persistent storage for data
# ============================================================================
volumes:
  traefik_data:
    external: true # Create with: docker volume create traefik_data
  nominatim-data: # Stores the PostgreSQL database (this is the big one!)
    driver: local
  nominatim-flatnode: # Stores search indexes
    driver: local
  redis_data:
    driver: local
  n8n_data:
    driver: local

# ============================================================================
# Networks - Internal communication between containers
# ============================================================================
networks:
  app-network:
    driver: bridge
  geocoding-network:
    driver: bridge
