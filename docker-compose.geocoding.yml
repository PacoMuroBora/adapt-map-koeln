version: '3.8'

# ============================================================================
# Docker Compose Configuration for Geocoding Services
# ============================================================================
#
# This file configures two geocoding services:
# 1. Nominatim - Reverse geocoding (coordinates → address/postal code)
# 2. Photon - Forward geocoding (address → coordinates)
#
# Deploy this on Hostinger VPS for production use.
#
# Quick Start:
#   1. Create .env file with: NOMINATIM_PASSWORD=your_secure_password
#   2. Run: docker-compose -f docker-compose.geocoding.yml up -d
#   3. Monitor: docker-compose -f docker-compose.geocoding.yml logs -f nominatim
#
# For detailed setup instructions, see: docs/geocoding-services-setup.md
# ============================================================================

services:
  nominatim:
    # Nominatim is the reverse geocoding service (coordinates → address)
    image: mediagis/nominatim:4.2
    container_name: nominatim
    restart: unless-stopped # Automatically restart if container crashes

    # Expose port 8080 so we can access Nominatim from outside the container
    ports:
      - '8080:8080'

    # Persistent storage for database and data
    volumes:
      - nominatim-data:/var/lib/postgresql/14/main # Database storage
      - nominatim-flatnode:/nominatim/flatnode # Index storage

    environment:
      # ====================================================================
      # IMPORTANT: Choose your region!
      # ====================================================================
      # Option 1: NRW only (faster, less resources) - RECOMMENDED FOR TESTING
      # - PBF_URL=https://download.geofabrik.de/europe/germany/nordrhein-westfalen-latest.osm.pbf
      # - REPLICATION_URL=https://download.geofabrik.de/europe/germany/nordrhein-westfalen-updates/
      #
      # Option 2: All of Germany (slower, more resources) - FOR PRODUCTION
      - PBF_URL=https://download.geofabrik.de/europe/germany-latest.osm.pbf
      - REPLICATION_URL=https://download.geofabrik.de/europe/germany-updates/
      # ====================================================================

      # Disable features we don't need (saves time and space)
      - IMPORT_WIKIPEDIA=false
      - IMPORT_US_POSTCODES=false

      # Database password - MUST be set in .env file!
      # Create .env file with: NOMINATIM_PASSWORD=your_secure_password_here
      - NOMINATIM_PASSWORD=${NOMINATIM_PASSWORD:-change_me_in_production}
    # Health check - Docker will verify the service is working
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/status']
      interval: 30s # Check every 30 seconds
      timeout: 10s # Wait 10 seconds for response
      retries: 3 # Try 3 times before marking as unhealthy
      start_period: 2h # Allow 2 hours for initial import (this is normal!)

    # Resource limits - adjust based on your VPS capacity
    # If you have less RAM, reduce these values
    deploy:
      resources:
        limits:
          memory: 6G # Maximum RAM Nominatim can use
        reservations:
          memory: 4G # Minimum RAM to reserve for Nominatim
    networks:
      - geocoding-network

  photon:
    # Photon is the forward geocoding service (address → coordinates)
    image: komoot/photon:latest
    container_name: photon
    restart: unless-stopped

    # Expose port 2322 so we can access Photon from outside the container
    ports:
      - '2322:2322'

    environment:
      # Photon connects to Nominatim's database (they share data)
      - NOMINATIM_HOST=nominatim # Internal Docker network name
      - NOMINATIM_PORT=5432 # PostgreSQL port
      - NOMINATIM_DB=nominatim # Database name
      - NOMINATIM_USER=nominatim # Database user
      - NOMINATIM_PASSWORD=${NOMINATIM_PASSWORD:-change_me_in_production} # Same password as Nominatim

    # Wait for Nominatim to be healthy before starting
    depends_on:
      nominatim:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:2322/api?q=test']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - geocoding-network

# ============================================================================
# Volumes - Persistent storage for data
# ============================================================================
# These volumes store the database and indexes even if containers are removed
volumes:
  nominatim-data: # Stores the PostgreSQL database (this is the big one!)
    driver: local
  nominatim-flatnode: # Stores search indexes
    driver: local

# ============================================================================
# Networks - Internal communication between containers
# ============================================================================
# Allows Photon to talk to Nominatim's database
networks:
  geocoding-network:
    driver: bridge
